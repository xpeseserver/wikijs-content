---
title: Firewall
description: firewall used
published: 1
date: 2022-06-20T11:19:59.739Z
tags: docker, security, server
editor: markdown
dateCreated: 2022-01-20T07:52:17.587Z
---

# iptables
## tools
lxc can talk to internet
```
iptables -t nat -A POSTROUTING -s 10.10.10.0/24 -o vmbr0 -j MASQUERADE
```

port forwarding tp lxc container
```
iptables -t nat -A PREROUTING -i vmbr0 -p tcp -m tcp --dport 81 -j DNAT --to-destination 10.10.10.2:81
```

show things
```
iptables -t nat -nvL
iptables -nvL
```

save iptables
```
iptables-save > /etc/iptables/rules.v4
```

## Config: 20.06.2022
```
# Generated by iptables-save v1.8.7 on Sun Jun 19 00:41:42 2022
*nat
:PREROUTING ACCEPT [50667:5214530]
:INPUT ACCEPT [29084:1573798]
:OUTPUT ACCEPT [693:42929]
:POSTROUTING ACCEPT [4856:292212]
#Webapplications/Reverse Proxy
-A PREROUTING -i vmbr0 -p tcp -m tcp --dport 80 -j DNAT --to-destination 10.10.10.2:80
-A PREROUTING -i vmbr0 -p tcp -m tcp --dport 443 -j DNAT --to-destination 10.10.10.2:443
-A PREROUTING -i vmbr0 -p udp -m udp --dport 9987 -j DNAT --to-destination 10.10.10.3:9987
#GameServer/FTP
-A PREROUTING -p tcp -m tcp --dport 25000:26000 -j DNAT --to-destination 10.10.10.150
-A PREROUTING -p udp -m udp --dport 25000:26000 -j DNAT --to-destination 10.10.10.150
-A PREROUTING -p tcp --dport 5657 -j DNAT --to 10.10.10.150
#OUTGOING from container too Outside Network
-A POSTROUTING -s 10.10.10.0/24 -o vmbr0 -j MASQUERADE
COMMIT
# Completed on Sun Jun 19 00:41:42 2022
# Generated by iptables-save v1.8.7 on Sun Jun 19 00:41:42 2022
*raw
:PREROUTING ACCEPT [1819965:1435367713]
:OUTPUT ACCEPT [510397:1014352861]
COMMIT
# Completed on Sun Jun 19 00:41:42 2022
# Generated by iptables-save v1.8.7 on Sun Jun 19 00:41:42 2022
*filter
:INPUT DROP [584589:240016889]
#ACCEPT known connections
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
#ACCEPT SSH from local network and from Bridged (internal) Network
-A INPUT -i vmbr0 -s 10.0.0.0/8 -p tcp --dport 22 -m state --state NEW -j ACCEPT
-A INPUT -i vmbr1 -s 10.0.0.0/8 -p tcp --dport 22 -m state --state NEW -j ACCEPT
#ACCEPT Proxmox connection (Webapplication)
-A INPUT -i vmbr0 -s 10.0.0.0/8 -p tcp --dport 8006 -m state --state NEW -j ACCEPT
-A INPUT -i vmbr1 -s 10.0.0.0/8 -p tcp --dport 8006 -m state --state NEW -j ACCEPT
-A INPUT -i vmbr0 -s 10.0.0.0/8 -p tcp --dport 5900:5999 -m state --state NEW -j ACCEPT
-A INPUT -i vmbr1 -s 10.0.0.0/8 -p tcp --dport 5900:5999 -m state --state NEW -j ACCEPT
-A INPUT -i vmbr0 -s 10.0.0.0/8 -p tcp --dport 3128 -m state --state NEW -j ACCEPT
-A INPUT -i vmbr1 -s 10.0.0.0/8 -p tcp --dport 3128 -m state --state NEW -j ACCEPT
-A INPUT -s 10.0.0.0/8 -p tcp -m multiport --dport 80,443 -m state --state NEW -j ACCEPT
-A INPUT -i lo -j ACCEPT
:FORWARD ACCEPT [1209092:1190287662]
:OUTPUT ACCEPT [510397:1014352861]
#ACCEPT known connections
-A OUTPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
COMMIT
# Completed on Sun Jun 19 00:41:42 2022
```

# UFW - outdated
## restrict docker
Add to end of `/etc/ufw/after.rules`

```
# BEGIN UFW AND DOCKER
*filter
:ufw-user-forward - [0:0]
:ufw-docker-logging-deny - [0:0]
:DOCKER-USER - [0:0]
-A DOCKER-USER -j ufw-user-forward

-A DOCKER-USER -j RETURN -s 10.0.0.0/8
-A DOCKER-USER -j RETURN -s 172.16.0.0/12
-A DOCKER-USER -j RETURN -s 192.168.0.0/16

-A DOCKER-USER -p udp -m udp --sport 53 --dport 1024:65535 -j RETURN

-A DOCKER-USER -j ufw-docker-logging-deny -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -d 192.168.0.0/16
-A DOCKER-USER -j ufw-docker-logging-deny -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -d 10.0.0.0/8
-A DOCKER-USER -j ufw-docker-logging-deny -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -d 172.16.0.0/12
-A DOCKER-USER -j ufw-docker-logging-deny -p udp -m udp --dport 0:32767 -d 192.168.0.0/16
-A DOCKER-USER -j ufw-docker-logging-deny -p udp -m udp --dport 0:32767 -d 10.0.0.0/8
-A DOCKER-USER -j ufw-docker-logging-deny -p udp -m udp --dport 0:32767 -d 172.16.0.0/12

-A DOCKER-USER -j RETURN

-A ufw-docker-logging-deny -m limit --limit 3/min --limit-burst 10 -j LOG --log-prefix "[UFW DOCKER BLOCK] "
-A ufw-docker-logging-deny -j DROP

COMMIT
# END UFW AND DOCKER
```

## Usage

```
ufw [--dry-run] enable|disable|reload
ufw [--dry-run] default allow|deny|reject [incoming|outgoing]
ufw [--dry-run] logging on|off|LEVEL
    toggle logging. Logged packets use the LOG_KERN syslog facility. Systems configured for rsyslog
    support may also log to /var/log/ufw.log. Specifying a LEVEL turns logging on for the specified LEVEL.
    The default log level is 'low'.
ufw [--dry-run] reset
ufw [--dry-run] status [verbose|numbered]
ufw [--dry-run] show REPORT
ufw [--dry-run] [delete] [insert NUM] allow|deny|reject|limit [in|out] [log|log-all] PORT[/protocol]
ufw [--dry-run] [delete] [insert NUM] allow|deny|reject|limit [in|out on INTERFACE] [log|log-all]
    [proto protocol] [from ADDRESS [port PORT]] [to ADDRESS [port PORT]]
ufw [--dry-run] delete NUM
ufw [--dry-run] app list|info|default|update
```

### examples

`ufw status verbose`
`ufw app list`
`ufw allow 'Nginx Full'`
`ufw allow 80/tcp`
`ufw allow ssh`
`ufw [delete] allow in proto udp from 193.204.114.105 to 12.34.56.78 port 123`